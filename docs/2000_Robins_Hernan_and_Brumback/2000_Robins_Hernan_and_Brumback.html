<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.269">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Readings in Causal Inference, Fall 2023 - 3&nbsp; Marginal Structural Models</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../2000_Dawid/2000_Dawid.html" rel="next">
<link href="../1983_Rosenbaum_and_Rubin/1983_Rosenbaum_and_Rubin.html" rel="prev">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>

  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Marginal Structural Models</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="../">Readings in Causal Inference, Fall 2023</a> 
        <div class="sidebar-tools-main">
    <a href="https://github.com/ctesta01/CausalFall2023" title="Source Code" class="sidebar-tool px-1"><i class="bi bi-github"></i></a>
</div>
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Readings in Causal Inference, Fall 2023</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../1983_Rosenbaum_and_Rubin/1983_Rosenbaum_and_Rubin.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Central Role of Propensity Scores</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../2000_Robins_Hernan_and_Brumback/2000_Robins_Hernan_and_Brumback.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Marginal Structural Models</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../2000_Dawid/2000_Dawid.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Causal Inference Without Counterfactuals</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../2019_Aronow_Miller/2019_Aronow_Miller.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Foundations of Agnostic Statistics</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#introduction" id="toc-introduction" class="nav-link active" data-scroll-target="#introduction">Introduction</a></li>
  <li><a href="#time-dependent-confounding" id="toc-time-dependent-confounding" class="nav-link" data-scroll-target="#time-dependent-confounding">Time-Dependent Confounding</a></li>
  <li><a href="#counterfactuals-in-point-treatment-studies" id="toc-counterfactuals-in-point-treatment-studies" class="nav-link" data-scroll-target="#counterfactuals-in-point-treatment-studies">Counterfactuals in Point-Treatment Studies</a></li>
  <li><a href="#no-unmeasured-confounders" id="toc-no-unmeasured-confounders" class="nav-link" data-scroll-target="#no-unmeasured-confounders">No Unmeasured Confounders</a></li>
  <li><a href="#stabilized-weights" id="toc-stabilized-weights" class="nav-link" data-scroll-target="#stabilized-weights">Stabilized Weights</a></li>
  <li><a href="#time-dependent-treatments" id="toc-time-dependent-treatments" class="nav-link" data-scroll-target="#time-dependent-treatments">Time-Dependent Treatments</a></li>
  <li><a href="#censoring-by-loss-to-follow-up" id="toc-censoring-by-loss-to-follow-up" class="nav-link" data-scroll-target="#censoring-by-loss-to-follow-up">Censoring by Loss to Follow-Up</a></li>
  <li><a href="#limitations" id="toc-limitations" class="nav-link" data-scroll-target="#limitations">Limitations</a></li>
  <li><a href="#important-points-from-the-appendix" id="toc-important-points-from-the-appendix" class="nav-link" data-scroll-target="#important-points-from-the-appendix">Important Points from the Appendix</a></li>
  <li><a href="#simulations-to-build-intuition" id="toc-simulations-to-build-intuition" class="nav-link" data-scroll-target="#simulations-to-build-intuition">Simulations to Build Intuition</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title d-none d-lg-block"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Marginal Structural Models</span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<p><a href="https://ctesta01.github.io/CausalFall2023/">← Home</a></p>
<p>Notes on <i>Marginal Structural Models and Causal Inference in Epidemiology</i> by James M. Robins, Miguel Ángel Hernán, and Babette Brumback (2000), Epidemiology</p>
<p><a href="https://doi.org/10.1097/00001648-200009000-00011" class="uri">https://doi.org/10.1097/00001648-200009000-00011</a></p>
<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>The key problem this paper addresses is the bias induced by time-dependent confounders that are also affected by previous treatment — which are handled by the introduction of marginal structural models that can be consistently estimated using inverse-probability-of-treatment weighted (IPTW) estimators.</p>
<p><strong>Definition.</strong> <span class="vocab">Time-dependent confounders</span> are covariates that are a risk factor for, or predictor of, the event of interest and also predicts subsequent exposure.</p>
<p>We are particularly interested in time-dependent confounders that are also affected or predicted by past exposure history (Condition 2).</p>
</section>
<section id="time-dependent-confounding" class="level2">
<h2 class="anchored" data-anchor-id="time-dependent-confounding">Time-Dependent Confounding</h2>
<blockquote class="blockquote">
<p>Consider a follow-up study of HIV-infected patients. Let <span class="math inline">\(A_k\)</span> be the dose of the treatment or exposure of interest, say zidovudine (AZT) on the <span class="math inline">\(k\)</span>th day since start of follow-up. Let <span class="math inline">\(Y\)</span> be a dichotomous outcome of interest (for example, <span class="math inline">\(Y = 1\)</span> if HIV RNA is not detectable in the blood and 0 otherwise) measured at end of follow-up on day <span class="math inline">\(K+1\)</span>. Our goal is to estimate the time-dependent treatment <span class="math inline">\(A_k\)</span> on the outcome <span class="math inline">\(Y\)</span>.</p>
</blockquote>
<p>Let <span class="math inline">\(L_k\)</span> represent the vector of all measured risk factors on day <span class="math inline">\(k\)</span> for the outcome such as age, CD4 lymphocyte count, white blood count, hematocrit, diagnosis of AIDS, and presence of absence of symptoms and opportunistic infections. Let <span class="math inline">\(U_k\)</span> represent the value(s) on day <span class="math inline">\(k\)</span> of all unmeasured causal risk factors for <span class="math inline">\(Y\)</span>.</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/time_dependent_exposures1/time_dependent_exposures1.svg" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Figure 1a. The most complex of the causal graphs for time-dependent exposure.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/time_dependent_exposures2/time_dependent_exposures2.svg" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Figure 1b. Similar to the above graph, but missing the arrows from <span class="math inline">\(U_{t_1}\)</span> to <span class="math inline">\(A_{t_2}\)</span> for <span class="math inline">\(t_1, t_2 \in \{0, 1\}\)</span>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/time_dependent_exposures3/time_dependent_exposures3.svg" class="img-fluid figure-img" style="width:75.0%"></p>
<p></p><figcaption class="figure-caption">Figure 1c. Again similar to the above graph, but also missing the arrows from <span class="math inline">\(L_{t_1}\)</span> to <span class="math inline">\(A_{t_2}\)</span> for <span class="math inline">\(t_1, t_2 \in \{0, 1\}\)</span>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Before diving immediately into how to address time-varying confounding that is affected by antecedent exposures, we establish some preliminary findings in the setting of point-treatment studies.</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/point_exposure1/point_exposure1.svg" class="img-fluid figure-img" style="width:35.0%"></p>
<p></p><figcaption class="figure-caption">Figure 2a. A causal graph for a point-exposure.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/point_exposure2/point_exposure2.svg" class="img-fluid figure-img" style="width:35.0%"></p>
<p></p><figcaption class="figure-caption">Figure 2b. Similar to above but missing the arrow from <span class="math inline">\(U_0 o A_0\)</span>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/point_exposure3/point_exposure3.svg" class="img-fluid figure-img" style="width:35.0%"></p>
<p></p><figcaption class="figure-caption">Figure 2c. Again similar to above but missing the arrow from <span class="math inline">\(L_0 o A_0\)</span>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<div style="background: #E8F5E9; padding-left: 20px; padding-right: 20px; padding-top: 15px; border-color: #008b72; border-radius: 15px; border-style: solid;">
<p>I think Robins, Hernán, and Brumback summarize the problem with time-varying confounders quite clearly in section 7.1:</p>
<p>“… Standard regression methods adjust for covariates by including them in the model as regressors. These standard methods may fail to adjust appropriately for confounding due to measured confounders <span class="math inline">\(L_k\)</span> when treatment is time varying because (1) <span class="math inline">\(L_k\)</span> may be a confounder for later treatment and thus must be adjusted for, but (2) may also be affected by earlier treatment and thus should not be adjusted for by standard methods. A solution to this conundrum is to adjust for the time-dependent covariates <span class="math inline">\(L_k\)</span> by using them to calculate the weights <span class="math inline">\(sw_i\)</span> rather than by adding <span class="math inline">\(L_k\)</span> to the regression model as regressors.”</p>
</div>
</section>
<section id="counterfactuals-in-point-treatment-studies" class="level2">
<h2 class="anchored" data-anchor-id="counterfactuals-in-point-treatment-studies">Counterfactuals in Point-Treatment Studies</h2>
<p>In an effort to help orient the readers, the authors provide some basic background on causal inference in point-treatment studies (Figures 2a-2c) to help keep us all grounded before moving on to more complicated settings.</p>
<p>Through this section (<span class="math inline">\(\S2\)</span>) the authors contrast <span class="vocab">crude measures</span> with <span class="vocab">causal measures</span> explaining that the causal measures will equal the crude measures when the analysis is unconfounded.</p>
<p><span class="math display">\[cRD = Pr[Y = 1 | A_0 = 1] - Pr[Y = 1 | A_0 = 0] \quad \text{\small (Crude Risk Difference)}\]</span> <span class="math display">\[cRR = Pr[Y = 1 | A_0 = 1]/Pr[Y = 1 | A_0 = 0] \quad \text{\small (Crude Risk Ratio)}\]</span> <span class="math display">\[cOR = \frac{Pr[Y = 1 | A_0 = 1]/Pr[Y=1 | A_0 = 0]}{Pr[Y=0 | A_0 = 1]/Pr[Y=0 | A_0 = 0]} \quad \text{\small (Crude Odds Ratio)}\]</span></p>
<p><span class="math display">\[Pr[Y_{a_0 = 1} = 1] - Pr[Y_{a_0 = 0} = 1] \quad \text{\small (Causal Risk Difference)}\]</span> <span class="math display">\[Pr[Y_{a_0 = 1} = 1]/Pr[Y_{a_0 = 0} = 1] \quad \text{\small (Causal Risk Ratio)}\]</span> <span class="math display">\[\frac{Pr[Y_{a_0 = 1} = 1]/Pr[Y_{a_0 = 0} = 1]}{Pr[Y_{a_0=1}=0]/Pr[Y_{a_0=0} = 0]} \quad \text{\small (Causal Risk Ratio)}\]</span></p>
<p>Note that the way I’ve written the odds ratios is to make the structure of them obvious as ratios of odds, but of course one can re-express any fraction written <span class="math inline">\(\displaystyle \frac{a / b}{c / d} = \frac{a d}{b c}\)</span>, which is how they’re presented in the paper.</p>
<p>An important point they make is that because of the possibility of effect modification, the population causal parameter need not be the same as its estimate in a particular stratum of measured risk factors even if the treatment is unconfounded.</p>
<p>To estimate these quantities of interest, we might fit linear, exponential, and logistic models depending on expert knowledge about the nature of the data being considered (and what type of exposure-response curve we expect):</p>
<p><span class="math display">\[Pr[Y_{a_0} = 1] = \phi_0 + \phi_1 a_0\]</span> <span class="math display">\[\log Pr[Y_{a_0} = 1] = \theta_0 + \theta_1 a_0\]</span> <span class="math display">\[\text{logit} Pr[Y_{a_0} = 1] = \beta_0 + \beta_1 a_0\]</span></p>
<p>Interpreting, the causal RD is <span class="math inline">\(\phi_1\)</span>, the causal RR is <span class="math inline">\(e^{\theta_1}\)</span>, and the causal OR is <span class="math inline">\(e^{\beta_1}\)</span>.</p>
<p>These models are described as <span class="vocab">marginal</span> because they model the marginal distribution of the counterfactual random variables <span class="math inline">\(Y_{a_0=1}\)</span> and <span class="math inline">\(Y_{a_0=1}\)</span> rather than the joint distribution (as in, they do not model <span class="math inline">\(\text{cor}(Y_{a_0=1}, Y_{a_0=0})\)</span>). They are said to be <span class="vocab">structural</span> because they model the probabilities of counterfactual variables (apparently models for counterfactual variables are often called structural in the econometrics and social science literature).</p>
<p>I’m a little confused about their claim that these are <span class="vocab">saturated</span> models: they say that they’re saturated because each model has two unknown parameters and places no restriction on the probabilities for <span class="math inline">\(Y_{a_0 = 1}\)</span> and <span class="math inline">\(Y_{a_0 = 0}\)</span>. I guess I’m just used to a different definition of saturated in which saturation refers to the model having as many parameters as it has data points, which does not feel like it’s necessarily true here.</p>
</section>
<section id="no-unmeasured-confounders" class="level2">
<h2 class="anchored" data-anchor-id="no-unmeasured-confounders">No Unmeasured Confounders</h2>
<p>Next a claim is introduced: if we weight the observations by <span class="math inline">\(w_i = 1/Pr[A_0 = a_{0i} | L_0 = l_{0i}]\)</span> where <span class="math inline">\(l_{0i}\)</span> and <span class="math inline">\(a_{0i}\)</span> are the measured covariates and exposures for subject <span class="math inline">\(i\)</span>, then we should recover unbiased estimates of the causal quantities of interest.</p>
<p>A rough sketch of why this should work is presented that rests on two additional claims:</p>
<ol type="1">
<li>In the constructed pseudopopulation, <span class="math inline">\(A_0\)</span> should be unconfounded by the measured covariates <span class="math inline">\(L_0\)</span>.</li>
<li><span class="math inline">\(Pr(Y_{a_0=1} = 1)\)</span> and <span class="math inline">\(Pr(Y_{a_0=1} = 0)\)</span> are the same as in the true study population so that the causal RD, RR, and OR are the same in both populations.</li>
</ol>
<p><em>Proof of 1.</em> We want to show that <span class="math display">\[Pr^W(A = a | L = l) \stackrel{claim}{=} Pr^W(A = a),\]</span> where <span class="math inline">\(Pr^W\)</span> refers to probability in the reweighted pseudopopulation.</p>
<p>I will only show this for the case where both <span class="math inline">\(A\)</span> and <span class="math inline">\(L\)</span> are dichotomous.</p>
<p>First, we can establish that <span class="math display">\[Pr^W(A = a | L = l) = \frac{N_{(A = a, L =l)} w}{\sum_{i \colon L_i = l} w_i},\]</span> where <span class="math inline">\(w = 1/Pr(A = a|L=l)\)</span> is a scalar-value and</p>
<p><span class="math display">\[w_i = \left\{ \begin{array}{ll} 1/Pr(A=1|L=l) &amp; \text{ if } A_i = 1 \\
1/Pr(A=0|L=l) &amp; \text{ if } A_i = 0 \end{array}\right.\]</span></p>
<p>where <span class="math inline">\(N_{(A=a,L=l)} \stackrel{\text{def}}{=} \sum_{i \colon a_i = a, l_i = l} 1\)</span>.</p>
<p>Letting <span class="math inline">\(w' = 1/Pr(A = 1-a | L=l)\)</span>, then we have that:</p>
<p><span class="math display">\[Pr^W(A = a | L = l) = \frac{N_{(A=a, L=l)}w}{N_{(A=a,L=l)}w + N_{(A=1-a,L=l)}w'}.\]</span></p>
<p>Substituting that <span class="math inline">\(Pr(A = a | L = l)\)</span> is estimated by <span class="math inline">\(N_{(A=a,L=l)}/N_{(L=l)}\)</span>, we have that</p>
<script>
window.MathJax = {
  loader: {load: ['[tex]/cancel']},
  tex: {packages: {'[+]': ['cancel']}}
};
</script>
<p><span class="math display">\[Pr^W(A = a | L = l) = \frac{\cancel{N_{(A=a, L=l)}} \frac{N_{(L=l)}}{\cancel{N_{(A=a,L=l)}}}}{
\cancel{N_{(A=a,L=l)}} \frac{N_{(L=l)}}{\cancel{N_{(A=a,L=l)}}} + \cancel{N_{(A=1-a,L=l)}} \frac{N_{(L=l)}}{\cancel{N_{(A=1-a,L=l)}}}}\]</span> <span class="math display">\[ = \frac{N_{(L=l)}}{2 N_{(L=l)}}\]</span> <span class="math display">\[ = \frac{1}{2}\]</span></p>
<p>In general, if <span class="math inline">\(L\)</span> took on more than just two values, we find that the probability that <span class="math inline">\(A=a\)</span> is the inverse of the number of levels of <span class="math inline">\(L\)</span>, which is independent of any single value that <span class="math inline">\(L\)</span> could take on.</p>
<div style="text-align: right">
<span class="math inline">\(\square\)</span>
</div>
<p>If we consider the 3-way tables necessary in the situation when <span class="math inline">\(A\)</span>, <span class="math inline">\(L\)</span>, and <span class="math inline">\(Y\)</span> are each dichotomous, we’re looking at something like this (for a simulated study of 1,000 participants):</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="script_examples/point_treatment_confounding/original_table.svg" class="img-fluid figure-img" style="width:3.5in"></p>
</figure>
</div>
</div>
</div>
<p>After applying inverse probability of treatment weights:</p>
<div class="cell" data-layout-align="center">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="script_examples/point_treatment_confounding/table_w_weights.svg" class="img-fluid figure-img" style="width:3.5in"></p>
</figure>
</div>
</div>
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="script_examples/point_treatment_confounding/reweighted_table.svg" class="img-fluid figure-img" style="width:3.5in"></p>
</figure>
</div>
</div>
</div>
<p>After some searching, I believe I have found a proof, in Rebecca Barter’s blog-post on <a href="https://www.rebeccabarter.com/blog/2017-07-05-ip-weighting"><em>The intuition behind inverse probability weighting in causal inference</em></a>.</p>
<p>Before getting into the proof, she helpfully reminds us that a causal estimand is identifiable when (1) <span class="vocab">exchangeability/ignorability</span>, (2) <span class="vocab">consistency</span>, and (3) <span class="vocab">positivity</span> all hold.</p>
<p><em>Definition.</em> <span class="vocab">Exchangeability</span> is the assumption we can re-arrange our observations without altering our conclusions. In the context of causal inference, we’re saying that we’d like our observations to be identically and independently distributed, same for the treatment assignment mechanism, and that therefore except for the treatment individual units received, we can permute them without changing our results.</p>
<p><em>Definition.</em> <span class="vocab">Consistency</span> refers to whether or not our model of potential (unobserved) outcomes is valid, in that our model is <em>consistent</em> with the reality of the data generating processes if we are making accurate statements regarding <span class="math inline">\(Pr(\text{outcomes}|\text{exposures}).\)</span></p>
<p><em>Definition.</em> <span class="vocab">Positivity</span> refers to the fact that all observations necessarily must have strictly positive probability of being assigned to either the treatment or control group — because otherwise if there is 0 probability of assignment to one of the treatment or control groups, we will necessarily lack observations from that group and thus unable to form causal estimates.</p>
<p>If we were to have exchangeability, consistency, and positivity, then we could say that the average treatment effect is estimated by <span class="math display">\[\frac{\sum_{i \colon A=1} Y_i}{N_{(A=1)}} - \frac{\sum_{i \colon A = 0} Y_i}{N_{(A=0)}},\]</span> since by exchangeability the observations are not confounded.</p>
<p>Now we can proceed to proving the claim that re-weighting the population as described produces a pseudopopulation in which the causal estimate is unbiased.</p>
<p><em>Proof.</em> Let <span class="math inline">\(p(l) = Pr(A=1|L=l)\)</span> where for treated individuals we will weight them by <span class="math inline">\(1/p(l)\)</span> and for untreated individuals we will weight them by <span class="math inline">\(1/(1-p(l))\)</span> and we would estimate <span class="math inline">\(\hat p\)</span> by a logistic regression model.</p>
<p>The causal estimate with inverse probability of treatment weighting is then given by:</p>
<p><span class="math display">\[\sum_{i \colon A=1} \frac{Y_i}{N_{(A=1)} \hat p(L_i)} - \sum_{i \colon A = 0}
\frac{Y_i}{N_{(A=0)} (1-\hat p(L_i))}\]</span></p>
<p><span class="math display">\[ = \sum_{i}^n \frac{Y_iA_i}{n \hat p(L_i)} - \sum_{i}^n
\frac{Y_i(1-A_i)}{n (1-\hat p(L_i))},\]</span></p>
<p>where <span class="math inline">\(n\)</span> is the total population size of observations and <span class="math inline">\(N_(...)\)</span> is my short-hand notation for <span class="math inline">\(\displaystyle \sum_{i \colon ...} 1\)</span>.</p>
<p>What remains to be checked is if the above is equal to <span class="math inline">\(\mathbb E[Y_{A=1}] - \mathbb E[Y_{A=0}]\)</span> (with respect to the super-population that we assume is exchangeable/unconfounded).</p>
<p>We will do so by verifying that <span class="math inline">\(\mathbb E\left[ \frac{YA}{p(L)} \right] = \mathbb E[Y_{A=1}]\)</span> (and the same steps would follow for showing <span class="math inline">\(\mathbb E\left[ \frac{Y(1-A)}{1-p(L)} \right] = \mathbb E[Y_{A=0}]\)</span>.</p>
<p><span class="math display">\[\begin{aligned}
\mathbb E\left[ \frac{YA}{p(L)} \right] &amp; = \mathbb E\left[\mathbb E\left[ \frac{YA}{p(L)} \middle\vert L \right] \right] \\
&amp; = \mathbb E\left[\mathbb E\left[ \frac{Y_{A=1}A}{p(L)} \middle\vert L \right] \right] \\
&amp; = \mathbb E\left[\frac{\mathbb E[Y_{A=1}|L] \mathbb E[A|L]}{p(L)} \right] \\
&amp; = \mathbb E\left[\frac{\mathbb E[Y_{A=1}|L] \cancel{\mathbb E[A|L]}}{\cancel{\mathbb E[A|L]}} \right] \\
&amp; = \mathbb E\left[\mathbb E[Y_{A=1}|L]\right] \\
&amp; = \mathbb E\left[Y_{A=1}\right]. \\
\end{aligned}
\]</span></p>
<p>Hence we can conclude that the inverse probability of treatment weighting yields an unbiased estimator for the causal effect.</p>
<div style="text-align: right">
<span class="math inline">\(\square\)</span>
</div>
</section>
<section id="stabilized-weights" class="level2">
<h2 class="anchored" data-anchor-id="stabilized-weights">Stabilized Weights</h2>
<p>Robins, Hernán, and Brumback go on to say that if levels of <span class="math inline">\(A\)</span> and <span class="math inline">\(L\)</span> are strongly associated, then it is likely that we will see quite large inverse probability of treatment weights. Such undesired variability in our estimated weights suggest that few individuals may inappropriately dominate the pseudopopulation and hence the weighted analysis.</p>
<p>To mitigate this, they introduce “stabilized weights” which are written as <span class="math display">\[sw_i = \frac{Pr(A = a_i)}{Pr(A=a_i | L=l_i)},\]</span> which are the same weights as before just multiplied by <span class="math inline">\(Pr(A=A_i)\)</span>.</p>
<p>I am suspicious that the reason we’re able to do this trick is because if we refer back to the proof that the original weights provided an unbiased estimator, we saw that <span class="math display">\[\mathbb E\left[ \frac{Y_{A=1}A}{p(L)} \right] = \mathbb E\left[ Y_{A=1} \right],\]</span> and if we work the same argument through with the stabilized weights, I think we’d get <span class="math inline">\(\mathbb E\left[ Y_{A=1} \mathbb E[A] \right]\)</span> instead. However, since <span class="math inline">\(\mathbb E[Y_{A=1}]\)</span> is the expected value of <span class="math inline">\(Y\)</span> when <span class="math inline">\(A=1\)</span>, I think we can say that the prior quantity is equal to <span class="math inline">\(\mathbb E\left[ Y \mathbb E[A] \middle\vert A = 1\right] = \mathbb E\left[ Y \middle \vert A = 1 \right] = \mathbb E[ Y_{A=1} ].\)</span></p>
</section>
<section id="time-dependent-treatments" class="level2">
<h2 class="anchored" data-anchor-id="time-dependent-treatments">Time-Dependent Treatments</h2>
<p>Returning to the setting of time-dependent confounding as in Figures 1a-c, let <span class="math inline">\(A_k\)</span> represent the dosage of a treatment on the <span class="math inline">\(k\)</span>th day from start of follow-up, <span class="math inline">\(Y\)</span> is a dichotomous variable measured at the end of follow-up on day <span class="math inline">\(K+1\)</span> , and <span class="math inline">\(L_k\)</span> represents all measured risk factors for the outcome on day <span class="math inline">\(k\)</span>. We’ll let <span class="math inline">\(\bar A_k = (A_0, A_1, ..., A_k)\)</span> be the treatment or exposure history thorugh day <span class="math inline">\(k\)</span> and let <span class="math inline">\(\bar A = \bar A_K\)</span>.</p>
<p>Generally we’ll be more interested in the cumulative effect of dosage (<span class="math inline">\(\sum a_k\)</span>) rather than specific dosage histories <span class="math inline">\(\bar a\)</span> when thinking about counterfactuals.</p>
<p><em>Assuming no loss to follow-up selection bias or measurement error</em>, we can unbiasedly estimate causal quantities using a logistic regression model</p>
<p><span class="math display">\[ \text{logistic}(Pr[Y=1 | \bar A = \bar a]) = \beta_0 + \beta_1 \sum a_k, \]</span> if treatment is unconfounded.</p>
<p>However, if treatment is confounded, we need to reweight the population by stabilized weights given by</p>
<p><span class="math display">\[sw_i = \frac{\displaystyle \prod_{k=0}^K Pr(A_k = a_{ki} | \bar A_{k-1} = \bar a_{(k-1)i})}{
\displaystyle \prod_{k=0}^K Pr(A_k = a_{ki} | \bar A_{k-1} = \bar a_{(k-1)i}, \bar L_k = \bar l_{ki}).
}\]</span></p>
</section>
<section id="censoring-by-loss-to-follow-up" class="level2">
<h2 class="anchored" data-anchor-id="censoring-by-loss-to-follow-up">Censoring by Loss to Follow-Up</h2>
<p>They say that we can also consider censoring at time <span class="math inline">\(k\)</span> (denoted <span class="math inline">\(C_k\)</span>) as another aspect of treatment and re-work our analyses to become “inverse-probability-of-treatment-and-censoring weighted estimators” if we view <span class="math inline">\((A_k, C_k)\)</span> as a joint-treatment at time <span class="math inline">\(k\)</span>.</p>
</section>
<section id="limitations" class="level2">
<h2 class="anchored" data-anchor-id="limitations">Limitations</h2>
<p>The authors state that marginal structural models cannot be used to model the interaction of treatment with a time-varying covariate (so effect modification). For this, they recommend structural nested models to be used.</p>
<p>As suggested above, it’s also the case that we cannot use marginal structural models when we have violations to the positivity assumption.</p>
</section>
<section id="important-points-from-the-appendix" class="level2">
<h2 class="anchored" data-anchor-id="important-points-from-the-appendix">Important Points from the Appendix</h2>
<p>If we recall the recommendations from <a href="https://ctesta01.github.io/CausalFall2023/1983_Rosenbaum_and_Rubin/1983_Rosenbaum_and_Rubin.html">Rosenbaum and Rubin, 1983</a>, it’s worth distinguishing the approach suggested here from the propensity score based approaches previously. The propensity score methods were largely oriented towards either propensity score stratification, propensity score matching, or covariance adjustment for propensity scores. It’s very much worth noting that the inverse of the propensity score is not the same as the inverse probability of treatment proposed here, as the propensity score always models <span class="math inline">\(Pr(A=1|L=l)\)</span> while the probability of treatment is the probability of the treatment <em>a specific unit received</em>, so <span class="math inline">\(Pr(A=a_i | L=l_i)\)</span>. In other words, for those units which were treated, the propensity score and the probability of treatment agree, but for untreated units, the probability of the treatment they received (no-treatment) is <span class="math inline">\(1-Pr(A=1|L=l_i)\)</span>.</p>
<p>As an additional consideration, it’s worth noting that matching or stratification methods could introduce significant bias if there is difficulty finding sufficiently close matches or residual uncontrolled-for intrastratum confounding.</p>
</section>
<section id="simulations-to-build-intuition" class="level2">
<h2 class="anchored" data-anchor-id="simulations-to-build-intuition">Simulations to Build Intuition</h2>
<p>I’ve been motivated by the question “how can we tell that we’ve implemented our marginal structural model (MSM) correctly if we allow ourselves to check our work in a simulation setting?”</p>
<p>My idea for “checking” centers around the idea that we can simulate data with varying strength on the pathways from the <span class="math inline">\(L\)</span> (the time-varying confounders affected by the exposures) variables to the <span class="math inline">\(A\)</span> (exposure) variables and compare what happens in MSMs comparing to the setting where there was 0 confounding.</p>
<p>To come up with a more straightforward setting to test our ideas in, the following DAG is sufficient as an example of a scenario where time-varying-confounding affected by exposures exist:</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/simpler_tvcabte1/simpler_tvcabte1.svg" class="img-fluid figure-img" style="width:45.0%"></p>
<p></p><figcaption class="figure-caption">A simpler situation with time-varying confounders affected by exposures.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>We’ll introduce a few functions to simulate some data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to generate simulated data</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>generate_sim_data <span class="ot">&lt;-</span> <span class="cf">function</span>(N, confounding_path_strength) {</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>  L0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  A0 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> L0 <span class="sc">*</span> confounding_path_strength)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  L1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> L0 <span class="sc">+</span> A0)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  A1 <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> A0 <span class="sc">+</span> L0 <span class="sc">*</span> confounding_path_strength <span class="sc">+</span> L1 <span class="sc">*</span> confounding_path_strength)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(N, <span class="at">mean =</span> A0 <span class="sc">+</span> A1 <span class="sc">+</span> L1)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">data.frame</span>(<span class="at">L0 =</span> L0, <span class="at">A0 =</span> A0, <span class="at">L1 =</span> L1, <span class="at">A1 =</span> A1, <span class="at">Y =</span> Y)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Function to calculate stabilized IPTW</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Note that since the above data generating function uses continuous variables, we </span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># estimate the densities of observations</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>calculate_stable_weights <span class="ot">&lt;-</span> <span class="cf">function</span>(data) {</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  model_A0 <span class="ot">&lt;-</span> <span class="fu">lm</span>(A0 <span class="sc">~</span> L0, <span class="at">data =</span> data)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  model_A1 <span class="ot">&lt;-</span> <span class="fu">lm</span>(A1 <span class="sc">~</span> A0 <span class="sc">+</span> L0 <span class="sc">+</span> L1, <span class="at">data =</span> data)</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  weights_A0 <span class="ot">&lt;-</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> <span class="sc">/</span> <span class="fu">dnorm</span>(</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> data<span class="sc">$</span>A0,</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">coef</span>(model_A0)[<span class="dv">1</span>],</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> <span class="fu">summary</span>(model_A0)<span class="sc">$</span>sigma</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  weights_A1 <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">dnorm</span>(</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> data<span class="sc">$</span>A1,</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">mean =</span> <span class="fu">coef</span>(model_A1)[<span class="dv">1</span>] <span class="sc">+</span> <span class="fu">coef</span>(model_A1)[<span class="dv">2</span>] <span class="sc">*</span> data<span class="sc">$</span>A0 <span class="sc">+</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>      <span class="fu">coef</span>(model_A1)[<span class="dv">3</span>] <span class="sc">*</span> data<span class="sc">$</span>L0 <span class="sc">+</span> <span class="fu">coef</span>(model_A1)[<span class="dv">4</span>] <span class="sc">*</span> data<span class="sc">$</span>L1,</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">sd =</span> <span class="fu">summary</span>(model_A1)<span class="sc">$</span>sigma</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  model_A0_alone <span class="ot">&lt;-</span> <span class="fu">lm</span>(A0 <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> data)</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>  model_A1_stabilizer <span class="ot">&lt;-</span> <span class="fu">lm</span>(A1 <span class="sc">~</span> A0, <span class="at">data =</span> data)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  A0_stabilizer <span class="ot">&lt;-</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dnorm</span>(</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> data<span class="sc">$</span>A0,</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">coef</span>(model_A0_alone)[<span class="dv">1</span>],</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> <span class="fu">summary</span>(model_A0_alone)<span class="sc">$</span>sigma</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>  A1_stabilizer <span class="ot">&lt;-</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">dnorm</span>(</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>      <span class="at">x =</span> data<span class="sc">$</span>A1,</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>      <span class="at">mean =</span> <span class="fu">coef</span>(model_A0_alone)[<span class="dv">1</span>] <span class="sc">+</span> data<span class="sc">$</span>A0 <span class="sc">*</span> <span class="fu">coef</span>(model_A1_stabilizer)[<span class="dv">2</span>],</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>      <span class="at">sd =</span> <span class="fu">summary</span>(model_A1_stabilizer)<span class="sc">$</span>sigma</span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>  A0_stabilizer <span class="sc">*</span> A1_stabilizer <span class="sc">*</span> weights_A0 <span class="sc">*</span> weights_A1</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Just to check that everything is working right, we might do a pair of simulations to compare:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate simulated data</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>confounding_path_strength <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>sim_data <span class="ot">&lt;-</span> <span class="fu">generate_sim_data</span>(N, confounding_path_strength)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate weights</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>sim_data<span class="sc">$</span>stable_weights <span class="ot">&lt;-</span> <span class="fu">calculate_stable_weights</span>(sim_data)</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Unadjusted model</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>model_unadjusted <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A0 <span class="sc">+</span> A1, <span class="at">data =</span> sim_data)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>jtools<span class="sc">::</span><span class="fu">summ</span>(model_unadjusted, <span class="at">model.info=</span><span class="cn">FALSE</span>, <span class="at">model.fit =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Est.
</th>
<th style="text-align:right;">
S.E.
</th>
<th style="text-align:right;">
t val.
</th>
<th style="text-align:right;">
p
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
(Intercept)
</td>
<td style="text-align:right;">
0.08
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
2.01
</td>
<td style="text-align:right;">
0.04
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
A0
</td>
<td style="text-align:right;">
0.88
</td>
<td style="text-align:right;">
0.07
</td>
<td style="text-align:right;">
13.16
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
A1
</td>
<td style="text-align:right;">
1.53
</td>
<td style="text-align:right;">
0.02
</td>
<td style="text-align:right;">
75.15
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> Standard errors: OLS
</td>
</tr>
</tfoot>

</table>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Adjust for confounders using MSM</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>model_msm <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A0 <span class="sc">+</span> A1, <span class="at">data =</span> sim_data, <span class="at">weights =</span> sim_data<span class="sc">$</span>stable_weights)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>jtools<span class="sc">::</span><span class="fu">summ</span>(model_msm, <span class="at">model.info=</span><span class="cn">FALSE</span>, <span class="at">model.fit =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">

<table class="table table-striped table-hover table-condensed table-responsive" style="width: auto !important; margin-left: auto; margin-right: auto;border-bottom: 0;">
<thead>
<tr>
<th style="text-align:left;">
</th>
<th style="text-align:right;">
Est.
</th>
<th style="text-align:right;">
S.E.
</th>
<th style="text-align:right;">
t val.
</th>
<th style="text-align:right;">
p
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;font-weight: bold;">
(Intercept)
</td>
<td style="text-align:right;">
0.17
</td>
<td style="text-align:right;">
0.05
</td>
<td style="text-align:right;">
3.44
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
A0
</td>
<td style="text-align:right;">
1.23
</td>
<td style="text-align:right;">
0.11
</td>
<td style="text-align:right;">
11.49
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
<tr>
<td style="text-align:left;font-weight: bold;">
A1
</td>
<td style="text-align:right;">
1.46
</td>
<td style="text-align:right;">
0.04
</td>
<td style="text-align:right;">
41.63
</td>
<td style="text-align:right;">
0.00
</td>
</tr>
</tbody>
<tfoot>
<tr>
<td style="padding: 0; " colspan="100%">
<sup></sup> Standard errors: OLS
</td>
</tr>
</tfoot>

</table>
</div>
</div>
<p>If the above estimates are showing us that in the marginal structural model with IPTW we’re getting coefficients on <span class="math inline">\(A_0\)</span> of roughly 2 and coefficients on <span class="math inline">\(A_1\)</span> of roughly 1, that would make a lot of sense. If we consider the DAG where we’re controlling for <span class="math inline">\(A_1\)</span> (as in the regression performed for <code>model_msm</code>), we can see that there’s two pathways (shown in blue below) through which <span class="math inline">\(A_0\)</span> contributes to the outcome <span class="math inline">\(Y\)</span>, and only the one direct pathway from <span class="math inline">\(A_1\)</span> to <span class="math inline">\(Y\)</span> (shown in red).</p>
<div class="cell">
<div class="cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="standalone_figures/simpler_tvcabte2/simpler_tvcabte2.svg" class="img-fluid figure-img" style="width:45.0%"></p>
<p></p><figcaption class="figure-caption">Pathways from the exposure to the outcome once we remove the arrows from <span class="math inline">\(L_{0,1} \to A_{0,1}\)</span>.</figcaption><p></p>
</figure>
</div>
</div>
</div>
<p>Now we can finally investigate whether or not my intuition is right:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Look at estimates when confounding_path_strength is ramped up or down </span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (confounding_path_strength <span class="cf">in</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">1</span>,<span class="dv">1</span>,<span class="at">length.out =</span> <span class="dv">7</span>)) {</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Generate simulated data</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  N <span class="ot">&lt;-</span> <span class="dv">1000</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>  sim_data <span class="ot">&lt;-</span> <span class="fu">generate_sim_data</span>(N, confounding_path_strength)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Calculate weights</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  sim_data<span class="sc">$</span>stable_weights <span class="ot">&lt;-</span> <span class="fu">calculate_stable_weights</span>(sim_data)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Unadjusted model</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  model_unadjusted <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A0 <span class="sc">+</span> A1, <span class="at">data =</span> sim_data)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Adjust for confounders using MSM</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  model_msm <span class="ot">&lt;-</span> <span class="fu">lm</span>(Y <span class="sc">~</span> A0 <span class="sc">+</span> A1, <span class="at">data =</span> sim_data, <span class="at">weights =</span> sim_data<span class="sc">$</span>stable_weights)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store results from MSM model</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  results[[<span class="fu">length</span>(results)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">confounding_path_strength =</span> confounding_path_strength,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>      <span class="at">i =</span> i,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="st">'marginal structural model (with IPTW)'</span>,</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_msm)[<span class="dv">1</span>]),</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>      <span class="at">A0_effect =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_msm)[<span class="dv">2</span>]),</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">A1_effect =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_msm)[<span class="dv">3</span>]))</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># store results from unadjusted model</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>  results[[<span class="fu">length</span>(results)<span class="sc">+</span><span class="dv">1</span>]] <span class="ot">&lt;-</span> </span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(<span class="at">confounding_path_strength =</span> confounding_path_strength,</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">i =</span> i,</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">model =</span> <span class="st">'unadjusted'</span>,</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>      <span class="at">intercept =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_unadjusted)[<span class="dv">1</span>]),</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      <span class="at">A0_effect =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_unadjusted)[<span class="dv">2</span>]),</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      <span class="at">A1_effect =</span> <span class="fu">unname</span>(<span class="fu">coef</span>(model_unadjusted)[<span class="dv">3</span>]))</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a><span class="co"># turn into a dataframe</span></span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>results <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(results)</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>labelling_helper <span class="ot">&lt;-</span> <span class="cf">function</span>(x) { </span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">paste0</span>(<span class="st">"confounding path coefficient: "</span>, <span class="fu">round</span>(<span class="fu">as.numeric</span>(x), <span class="dv">1</span>))</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>results <span class="sc">|&gt;</span> </span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>  tidyr<span class="sc">::</span><span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="fu">c</span>(intercept, A0_effect, A1_effect), <span class="at">names_to =</span> <span class="st">'coefficient'</span>, <span class="at">values_to =</span> <span class="st">'estimate'</span>) <span class="sc">|&gt;</span> </span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(</span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> coefficient,</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> estimate,</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> model,</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">group =</span> model</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>  )) <span class="sc">+</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_jitter</span>(<span class="at">height =</span> <span class="dv">0</span>, <span class="at">width=</span>.<span class="dv">15</span>, <span class="at">alpha =</span> .<span class="dv">15</span>) <span class="sc">+</span> </span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">fun =</span> mean,</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">geom =</span> <span class="st">'point'</span>,</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">group =</span> model, <span class="at">shape =</span> model),</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">'grey30'</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">stat_summary</span>(<span class="at">fun =</span> mean, <span class="at">geom =</span> <span class="st">'line'</span>, <span class="fu">aes</span>(<span class="at">group =</span> model)) <span class="sc">+</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="sc">~</span> confounding_path_strength,</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">nrow =</span> <span class="dv">1</span>,</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">labeller =</span> <span class="fu">as_labeller</span>(labelling_helper)</span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(</span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">legend.position =</span> <span class="st">'bottom'</span>,</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">axis.text.x =</span> <span class="fu">element_text</span>(<span class="at">angle =</span> <span class="dv">15</span>, <span class="at">hjust =</span> <span class="dv">1</span>),</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">plot.caption =</span> <span class="fu">element_text</span>(<span class="at">hjust =</span> .<span class="dv">5</span>)</span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Variation in Coefficient Estimates with/without IPTW"</span>,</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>          <span class="at">subtitle =</span> <span class="st">"Datasets (N obs=1000) were simulated for varying coefficients for the confounding paths (L0→A0, L0→A1, L1→A1) 100 times"</span>) <span class="sc">+</span></span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">caption =</span> <span class="st">"Mean coefficient estimates from the 100 simulations are indicated by the black marks that are connected by colored lines for each model type."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<!--

::: {.cell}
::: {.cell-output-display}
![](script_examples/time_varying_confounding/time_varying_confounding_lt1.png)
:::
:::

-->
<p><img id="tvcabte1" src="script_examples/time_varying_confounding/time_varying_confounding_lt1.png" alt="The marginal structural models are are de-biased towards the scenario where there is no confounding compared with the naive models." style="width:100%"></p>
<p>What’s quite interesting to me is that when we start to ramp up the confounding path strength to be higher than 1, we start to run into scenarios where the variability in the <span class="math inline">\(A_0\)</span> estimate after IPTW is quite high and we fail to be able to continue to recover unbiased estimates of the <span class="math inline">\(A_0\)</span> and <span class="math inline">\(A_1\)</span> coefficients.</p>
<div class="cell">
<style type="text/css">
 /* Style the Image Used to Trigger the Modal */
#tvcabte1 {
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}

#tvcabte2 {
  border-radius: 5px;
  cursor: pointer;
  transition: 0.3s;
}

#tvcabte1:hover {opacity: 0.7;}
#tvcabte2:hover {opacity: 0.7;}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.9); /* Black w/ opacity */
}

/* Modal Content (Image) */
.modal-content {
  margin: auto;
  display: block;
  width: 95%;
}

/* Caption of Modal Image (Image Text) - Same Width as the Image */
#caption {
  margin: auto;
  display: block;
  width: 80%;
  max-width: 700px;
  text-align: center;
  color: #ccc;
  padding: 10px 0;
  height: 150px;
}

/* Add Animation - Zoom in the Modal */
.modal-content, #caption {
  animation-name: zoom;
  animation-duration: 0.6s;
}

@keyframes zoom {
  from {transform:scale(0)}
  to {transform:scale(1)}
}

/* The Close Button */
.close {
  position: absolute;
  top: 15px;
  right: 35px;
  color: #f1f1f1;
  font-size: 40px;
  font-weight: bold;
  transition: 0.3s;
}

.close:hover,
.close:focus {
  color: #bbb;
  text-decoration: none;
  cursor: pointer;
}

/* 100% Image Width on Smaller Screens */
@media only screen and (max-width: 700px){
  .modal-content {
    width: 100%;
  }
} 
</style>
</div>
<p><img id="tvcabte2" src="script_examples/time_varying_confounding/time_varying_confounding_wider_scenario.png" alt="IPTW appears to not be working so well once the confounding path strength exceeds ~1" style="width:100%"></p>
<div id="myModal" class="modal">
<p><!-- The Close Button --> <span class="close">×</span></p>
<p><!-- Modal Content (The Image) --> <img class="modal-content" id="img01"></p>
<!-- Modal Caption (Image Text) -->
<div id="caption">

</div>
</div>
<script>
 // Get the modal
var modal = document.getElementById("myModal");

// Get the image and insert it inside the modal - use its "alt" text as a caption
var img1 = document.getElementById("tvcabte1");
var img2 = document.getElementById("tvcabte2");
var modalImg = document.getElementById("img01");
var captionText = document.getElementById("caption");
img1.onclick = function(){
  modal.style.display = "block";
  modalImg.src = this.src;
  captionText.innerHTML = this.alt;
}
img2.onclick = function(){
  modal.style.display = "block";
  modalImg.src = this.src;
  captionText.innerHTML = this.alt;
}


// Get the <span> element that closes the modal
var span = document.getElementsByClassName("close")[0];

// When the user clicks on <span> (x), close the modal
span.onclick = function() {
  modal.style.display = "none";
} 

modal.onclick = function() {
  modal.style.display = "none";
} 

document.addEventListener('keydown', function(e) {
    if(e.keyCode == 27){
      modal.style.display = "none";
    }
});


</script>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://giscus.app/client.js" data-repo="ctesta01/CausalFall2023" data-repo-id="R_kgDOKJFkiQ" data-category="General" data-category-id="DIC_kwDOKJFkic4CY4aM" data-mapping="title" data-reactions-enabled="1" data-emit-metadata="0" data-input-position="top" data-theme="light" data-lang="en" crossorigin="anonymous" async="">
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../1983_Rosenbaum_and_Rubin/1983_Rosenbaum_and_Rubin.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">The Central Role of Propensity Scores</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../2000_Dawid/2000_Dawid.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Causal Inference Without Counterfactuals</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>